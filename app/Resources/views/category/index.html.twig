{% extends 'base.html.twig' %}
{% block title %}カテゴリ一覧{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .category-card {
            transition: transform 0.2s ease-in-out;
            height: 100%;
            border-left: 4px solid transparent;
        }
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .category-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .memo-count-badge {
            font-size: 0.85rem;
            font-weight: 600;
        }
        .search-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }
        .category-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid mt-4">
        <!-- ヘッダー -->
        <div class="category-header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="fas fa-tags text-primary mr-2"></i>カテゴリ一覧
                </h1>
                <a href="{{ path('category_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>新規カテゴリ作成
                </a>
            </div>
        </div>

        <!-- フラッシュメッセージ -->
        {% for message in app.flashes('success') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle mr-2"></i>{{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}

        {% for message in app.flashes('error') %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle mr-2"></i>{{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}

        <!-- 検索セクション -->
        <div class="search-section">
            <h5 class="mb-3">
                <i class="fas fa-search text-primary mr-2"></i>カテゴリ検索
            </h5>
            <form method="GET" action="{{ path('category_index') }}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control"
                                   name="keyword"
                                   value="{{ keyword }}"
                                   placeholder="カテゴリ名や説明で検索...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit">検索</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        {% if keyword %}
                            <a href="{{ path('category_index') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times mr-2"></i>検索クリア
                            </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>

        <!-- 検索結果情報 -->
        {% if keyword %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>
                「<strong>{{ keyword }}</strong>」の検索結果: {{ pagination.getTotalItemCount }}件
            </div>
        {% else %}
            <div class="alert alert-light border">
                <i class="fas fa-list mr-2"></i>
                全{{ pagination.getTotalItemCount }}件のカテゴリ
            </div>
        {% endif %}

        <!-- カテゴリ一覧 -->
        {% if pagination|length > 0 %}
            <div class="row">
                {% for category in pagination %}
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card category-card h-100"
                             style="border-left-color: {{ category.color }}">
                            <div class="card-body d-flex flex-column">
                                <!-- カテゴリヘッダー -->
                                <div class="d-flex align-items-center mb-3">
                                    <span class="category-color"
                                          style="background-color: {{ category.color }}"></span>
                                    <h5 class="card-title mb-0 text-truncate">
                                        {{ category.name }}
                                    </h5>
                                </div>

                                <!-- 説明文 -->
                                <div class="flex-grow-1">
                                    {% if category.description %}
                                        <p class="card-text text-muted">
                                            {% if category.description|length > 80 %}
                                                {{ category.description|slice(0, 80) }}...
                                            {% else %}
                                                {{ category.description }}
                                            {% endif %}
                                        </p>
                                    {% else %}
                                        <p class="card-text text-muted font-italic">
                                            <i class="fas fa-info-circle mr-1"></i>説明なし
                                        </p>
                                    {% endif %}
                                </div>

                                <!-- メタ情報 -->
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="badge badge-secondary memo-count-badge">
                                            <i class="fas fa-sticky-note mr-1"></i>
                                            {{ category.memoCount }}件
                                        </span>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt mr-1"></i>
                                            {{ category.createdAt|date('Y/m/d') }}
                                        </small>
                                    </div>

                                    <!-- アクションボタン -->
                                    <div class="btn-group w-100" role="group">
                                        <a href="{{ path('category_show', {'id': category.id}) }}"
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye mr-1"></i>詳細
                                        </a>
                                        <a href="{{ path('category_edit', {'id': category.id}) }}"
                                           class="btn btn-outline-warning btn-sm">
                                            <i class="fas fa-edit mr-1"></i>編集
                                        </a>
                                        {% if category.memoCount == 0 %}
                                            <button type="button"
                                                    class="btn btn-outline-danger btn-sm"
                                                    data-toggle="modal"
                                                    data-target="#deleteModal{{ category.id }}">
                                                <i class="fas fa-trash mr-1"></i>削除
                                            </button>
                                        {% else %}
                                            <span class="btn btn-outline-secondary btn-sm disabled"
                                                  title="メモが関連付けられているため削除できません">
                                                <i class="fas fa-lock mr-1"></i>削除
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 削除確認モーダル -->
                    {% if category.memoCount == 0 %}
                        <div class="modal fade" id="deleteModal{{ category.id }}" tabindex="-1" role="dialog">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>削除確認
                                        </h5>
                                        <button type="button" class="close text-white" data-dismiss="modal">
                                            <span>&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="text-center">
                                            <span class="category-color mb-3 d-inline-block"
                                                  style="background-color: {{ category.color }}; width: 40px; height: 40px;"></span>
                                            <h6>カテゴリ「<strong>{{ category.name }}</strong>」を削除しますか？</h6>
                                            <p class="text-muted small">この操作は取り消せません。</p>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                            <i class="fas fa-times mr-1"></i>キャンセル
                                        </button>
                                        <form method="POST"
                                              action="{{ path('category_delete', {'id': category.id}) }}"
                                              style="display: inline;">
                                            <input type="hidden" name="_token"
                                                   value="{{ csrf_token('delete' ~ category.id) }}">
                                            <button type="submit" class="btn btn-danger">
                                                <i class="fas fa-trash mr-1"></i>削除する
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- ページネーション -->
            {% if pagination.getTotalItemCount > 10 %}
                <div class="d-flex justify-content-center mt-4">
                    {{ knp_pagination_render(pagination) }}
                </div>
            {% endif %}
        {% else %}
            <!-- 空の状態 -->
            <div class="empty-state">
                <div class="icon">
                    <i class="fas fa-tags"></i>
                </div>
                {% if keyword %}
                    <h4 class="text-muted">検索結果が見つかりませんでした</h4>
                    <p class="mb-4">
                        「<strong>{{ keyword }}</strong>」に一致するカテゴリがありません。<br>
                        別のキーワードで検索してみてください。
                    </p>
                    <a href="{{ path('category_index') }}" class="btn btn-primary mb-2">
                        <i class="fas fa-list mr-1"></i>すべてのカテゴリを表示
                    </a>
                    <br>
                    <a href="{{ path('category_new') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus mr-1"></i>新しいカテゴリを作成
                    </a>
                {% else %}
                    <h4 class="text-muted">カテゴリがまだありません</h4>
                    <p class="mb-4">
                        メモを整理するために、最初のカテゴリを作成してみましょう！<br>
                        <small class="text-muted">例: 仕事、プライベート、学習など</small>
                    </p>
                    <a href="{{ path('category_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>最初のカテゴリを作成
                    </a>
                {% endif %}
            </div>
        {% endif %}

        <!-- ナビゲーション -->
        <div class="text-center mt-5 pt-4 border-top">
            <a href="{{ path('memo_index') }}" class="btn btn-outline-primary mr-2">
                <i class="fas fa-sticky-note mr-1"></i>メモ一覧に戻る
            </a>
            <a href="{{ path('homepage') }}" class="btn btn-outline-secondary">
                <i class="fas fa-home mr-1"></i>ホームに戻る
            </a>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function() {
            $('input[name="keyword"]').on('focus', function() {
              $(this).parent().addClass('shadow-sm');
            }).on('blur', function() {
              $(this).parent().removeClass('shadow-sm');
            });

          $('.category-card').hover(
            function() {
              $(this).find('.btn-group button, .button-group a').removeClass('btn-outline-primary btn-outline-warning btn-outline-danger')
                    .addClass('btn-primary btn-warning btn-danger');
            },
            function() {
              $(this).find('.btn-group .btn').removeClass('btn-outline-primary btn-outline-warning btn-outline-danger')
                    .addClass('btn-outline-primary btn-outline-warning btn-outline-danger');
            }
          );
        });
    </script>
{% endblock %}
