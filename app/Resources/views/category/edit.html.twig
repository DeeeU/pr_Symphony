{% extends 'base.html.twig' %}

{% block title %}{{ category.name }} - カテゴリ編集{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ffc107;
        }
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .current-info {
            background: linear-gradient(135deg, {{ category.color }}15 0%, {{ category.color }}05 100%);
            border-left: 4px solid {{ category.color }};
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: inline-block;
            margin-left: 10px;
        }
        .help-text {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .before-after {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .before-after > div {
            flex: 1;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="form-container">
            <!-- ページヘッダー -->
            <div class="form-header">
                <h1><i class="fas fa-edit text-warning mr-2"></i>カテゴリ編集</h1>
                <p class="text-muted mb-0">「{{ category.name }}」カテゴリの情報を編集します</p>
            </div>

            <!-- フラッシュメッセージ -->
            {% for message in app.flashes('error') %}
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle mr-2"></i>{{ message }}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            {% endfor %}

            <!-- 現在の情報 -->
            <div class="current-info">
                <h6><i class="fas fa-info-circle mr-2"></i>現在の設定</h6>
                <div class="d-flex align-items-center">
                    <span class="color-preview" style="background-color: {{ category.color }}"></span>
                    <div class="ml-3">
                        <strong>{{ category.name }}</strong>
                        {% if category.description %}
                            <br><small class="text-muted">{{ category.description }}</small>
                        {% endif %}
                        <br><small class="text-muted">作成日: {{ category.createdAt|date('Y年m月d日') }} | メモ数: {{ category.memoCount }}件</small>
                    </div>
                </div>
            </div>

            <!-- フォーム -->
            <div class="form-section">
                {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

                <!-- カテゴリ名 -->
                <div class="form-group">
                    {{ form_label(form.name, null, {'label_attr': {'class': 'font-weight-bold'}}) }}
                    {{ form_widget(form.name, {'attr': {'class': 'form-control form-control-lg', 'placeholder': 'カテゴリ名を入力してください'}}) }}
                    {{ form_errors(form.name) }}
                    <div class="help-text">
                        <i class="fas fa-info-circle mr-1"></i>
                        最大100文字まで入力可能です
                    </div>
                </div>

                <!-- 説明 -->
                <div class="form-group">
                    {{ form_label(form.description, null, {'label_attr': {'class': 'font-weight-bold'}}) }}
                    {{ form_widget(form.description, {'attr': {'class': 'form-control', 'placeholder': 'カテゴリの説明を入力してください（任意）', 'rows': 4}}) }}
                    {{ form_errors(form.description) }}
                    <div class="help-text">
                        <i class="fas fa-info-circle mr-1"></i>
                        このカテゴリの用途や内容について説明してください（任意）
                    </div>
                </div>

                <!-- 変更プレビュー -->
                <div class="form-group">
                    <label class="font-weight-bold">変更プレビュー</label>
                    <div class="card">
                        <div class="card-body">
                            <div class="before-after">
                                <div>
                                    <h6 class="text-muted mb-2">変更前</h6>
                                    <div class="d-flex align-items-center">
                                        <span class="color-preview" style="background-color: {{ category.color }}"></span>
                                        <div class="ml-3">
                                            <strong>{{ category.name }}</strong>
                                            {% if category.description %}
                                                <br><small class="text-muted">{{ category.description }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <i class="fas fa-arrow-right text-muted fa-2x"></i>
                                </div>
                                <div>
                                    <h6 class="text-warning mb-2">変更後</h6>
                                    <div class="d-flex align-items-center">
                                        <span id="colorPreview" class="color-preview" style="background-color: {{ category.color }}"></span>
                                        <div class="ml-3">
                                            <strong id="namePreview">{{ category.name }}</strong>
                                            <br><small class="text-muted" id="descriptionPreview">{{ category.description ?: '説明なし' }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 送信ボタン -->
                <div class="form-group text-center">
                    {{ form_widget(form.save, {'attr': {'class': 'btn btn-warning btn-lg px-5'}, 'label': '更新'}) }}
                    <a href="{{ path('category_show', {'id': category.id}) }}" class="btn btn-secondary btn-lg px-4 ml-2">
                        <i class="fas fa-times mr-1"></i>キャンセル
                    </a>
                </div>

                {{ form_end(form) }}
            </div>

            <!-- 警告 -->
            {% if category.memoCount > 0 %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>注意:</strong> このカテゴリには{{ category.memoCount }}件のメモが関連付けられています。
                    カテゴリ名を変更すると、関連するすべてのメモの表示にも反映されます。
                </div>
            {% endif %}

            <!-- その他のアクション -->
            <div class="text-center">
                <a href="{{ path('category_show', {'id': category.id}) }}" class="btn btn-outline-primary mr-2">
                    <i class="fas fa-eye mr-1"></i>詳細を見る
                </a>
                {% if category.memoCount == 0 %}
                    <button type="button" class="btn btn-outline-danger" data-toggle="modal" data-target="#deleteModal">
                        <i class="fas fa-trash mr-1"></i>削除
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- 削除確認モーダル -->
        {% if category.memoCount == 0 %}
            <div class="modal fade" id="deleteModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle mr-2"></i>削除確認
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body text-center">
                            <span class="color-preview mb-3 d-inline-block"
                                  style="background-color: {{ category.color }}; width: 60px; height: 60px;"></span>
                            <h6>カテゴリ「<strong>{{ category.name }}</strong>」を削除しますか？</h6>
                            <p class="text-muted">この操作は取り消せません。</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                キャンセル
                            </button>
                            <form method="POST" action="{{ path('category_delete', {'id': category.id}) }}" style="display: inline;">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ category.id) }}">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash mr-1"></i>削除する
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            // リアルタイムプレビュー機能
            function updatePreview() {
                var name = $('#appbundle_category_name').val() || '{{ category.name }}';
                var description = $('#appbundle_category_description').val() || '説明なし';

                $('#namePreview').text(name);
                $('#descriptionPreview').text(description);
            }

            // 初期表示時にプレビュー更新
            updatePreview();

            // 入力時にプレビュー更新
            $('#appbundle_category_name, #appbundle_category_description').on('input', updatePreview);

            // フォームバリデーション
            $('form').on('submit', function(e) {
                var name = $('#appbundle_category_name').val().trim();

                if (name.length === 0) {
                    e.preventDefault();
                    alert('カテゴリ名は必須です');
                    $('#appbundle_category_name').focus();
                    return false;
                }

                if (name.length > 100) {
                    e.preventDefault();
                    alert('カテゴリ名は100文字以内で入力してください');
                    $('#appbundle_category_name').focus();
                    return false;
                }
            });

            // 入力フィールドのフォーカス効果
            $('.form-control').on('focus', function() {
                $(this).parent().addClass('focused');
            }).on('blur', function() {
                $(this).parent().removeClass('focused');
            });

            // 変更検知
            var originalName = '{{ category.name }}';
            var originalDescription = '{{ category.description }}';

            $('#appbundle_category_name, #appbundle_category_description').on('input', function() {
                var currentName = $('#appbundle_category_name').val();
                var currentDescription = $('#appbundle_category_description').val();

                var hasChanges = (currentName !== originalName) || (currentDescription !== originalDescription);

                if (hasChanges) {
                    $('#appbundle_category_save').removeClass('btn-secondary').addClass('btn-warning').text('変更を保存');
                } else {
                    $('#appbundle_category_save').removeClass('btn-warning').addClass('btn-secondary').text('更新');
                }
            });
        });
    </script>
{% endblock %}
